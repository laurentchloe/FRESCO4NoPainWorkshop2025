---
title: "Hands-on Workshop: Exploring TMS Data"
authors: "SporeData OU"
output: pdf_document
---

# Welcome

This short tutorial will guide you through exploring Transcranial Magnetic Stimulation (TMS) study data using R. You don't need any prior coding or statistics experience, we'll go step by step.

# Requirements

Before getting started, make sure you have R installed on your computer.
You can download it for free from the official CRAN website: https://cran.r-project.org/

To make things easier, we also recommend using an IDE (Integrated Development Environment), which provides an interface that helps you write and run R code more smoothly.

If you're new to R, the best option is RStudio, since it's built specifically for R and is very beginner-friendly.
You can download RStudio here: https://posit.co/download/rstudio-desktop/

Both R and RStudio are free to download and use.

# Setup

Once you have R installed, you will also need a few extra tools (called packages). These are small add-ons that make R more powerful.

**Step 1 — Install the required packages**

Run this code once on your computer to install what we'll use today.

```{r install_pkg, message = FALSE, warning = FALSE, eval=FALSE}
# Install the required packages if not already installed
install.packages("dplyr")
install.packages("ggplot2")
install.packages("tableone")
install.packages("lme4")
install.packages("Rmarkdown")
install.packages("lmerTest")
```

**Step 2 — Load the packages**

You'll need to load these every time you open a new R session.

```{r load_pkg, message = FALSE, warning = FALSE}
# Load the required packages
library(dplyr)
library(ggplot2)
library(tableone)
library(lme4)
library(lmerTest)
```


# Load and peek at the data

Let's start by reading our dataset into R.

**What does this mean?**

* `read.csv()` tells R to open a spreadsheet file that's in CSV format.
* The result is stored in something called a data frame, a bit like an Excel sheet.

```{r load_data, message = FALSE, warning = FALSE}
# Path to your CSV file
path <- "data.csv"

# Read the CSV
data <- read.csv(path)
```

Take a quick look at the first few rows using `head()`, so you can confirm the data looks right.

```{r peek_data1, message = FALSE, warning = FALSE}
# Peek at the first few rows
head(data)
```

Then, see the structure (column names and data types) using `str()`. This is useful to check that, for example, numbers are numeric and not text. This command shows:

* Each column name
* The type of data (numbers, text, etc.)
* A few example values from each column

Think of this like "What kind of information do I have in each column?"

```{r peek_data2, message = FALSE, warning = FALSE}
str(data)
```

Finally, `summary()` provides summary statistics for each column. This gives quick numerical summaries:

* For numbers: minimum, mean, median, maximum
* For text or categories: how many of each type

At this point, you should have a good sense of what's inside your dataset.

```{r peek_data3, message = FALSE, warning = FALSE}
# Quick summary of each column
summary(data)
```


# Exploratory analysis

Now the fun part, visualizing what's happening in the data.

Before plotting, let's make sure the `time` variable appears in the correct order (pre > post > follow-up):

```{r order_time, message = FALSE, warning = FALSE}
data <- data %>%
  mutate(time = factor(time, levels = c("pre", "post", "followup")))
```

## Plot 1 - Symptom change over time by treatment

In TMS research, we often want to know: Do patients receiving active TMS improve more than those in the sham (placebo) group?

This plot shows average symptom scores at each stage of the study:

* **Pre**: before any treatment
* **Post**: immediately after treatment
* **Follow-up**: some time later

We'll add:

* **Dots** for mean symptom scores
* **Lines** connecting them over time
* **Error bars** showing uncertainty (standard error)

```{r plot1, message = FALSE, warning = FALSE}
ggplot(data, aes(x = time, y = symptom_score, color = treatment, group = treatment)) +
  stat_summary(fun = mean, geom = "line", linewidth = 1) +
  stat_summary(fun = mean, geom = "point", size = 3) +
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.1) +
  labs(
    title = "Symptom Change Over Time by Treatment",
    x = "Session Time",
    y = "Mean Symptom Score",
    color = "Treatment"
  ) +
  theme_minimal(base_size = 14)
```

**How to read this**

* The y-axis shows average symptom severity.
* The x-axis shows time: pre → post → follow-up.
* Two lines: one for each treatment type (active vs sham).
* If the active line goes down more steeply, patients improved more with active TMS.
* If both lines look similar, the sham effect may be similar (placebo or no effect).

**Clinically speaking**

This is your first visual check: is there an apparent treatment benefit?
Don't jump to conclusions yet, but you'll see whether the trend looks promising.

## Plot 2 - Change from baseline

Absolute scores are useful, but clinicians often care more about change from baseline: How much did the patient improve compared to where they started?

In the data, this is already computed in the column `delta_from_baseline` (baseline - follow-up). A high value means improvement (symptoms decreased).

We'll plot these changes for each group and time point.

```{r plot2, message = FALSE, warning = FALSE}
ggplot(data, aes(x = time, y = delta_from_baseline, fill = treatment)) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(0.8), width = 0.7) +
  stat_summary(fun.data = mean_se, geom = "errorbar",
               position = position_dodge(0.8), width = 0.2) +
  labs(
    title = "Change from Baseline by Time and Treatment",
    x = "Session Time",
    y = "Symptom Score (from baseline)",
    fill = "Treatment"
  ) +
  theme_minimal(base_size = 14)
```

**How to read this**

* Each bar shows the average change from baseline.
* High values indicate improvement.
* Compare active vs sham at post and follow-up.
* Look at the height difference: larger drops mean more improvement.

**Clinically speaking**

This plot gives a quick sense of treatment effect size, how much better the active group got relative to the sham group.

**Your turn**

Now that you’ve made two fundamental plots, try adding or changing things to dig deeper. Below are a few extra plots to explore, each demonstrating a different concept.

* Check whether brain response (MEP amplitude) is related to symptom improvement.
* Compare EEG signals between groups.


## Table one

A common clinical research step is to create a Table One summarizing baseline characteristics of your groups. This helps ensure groups are comparable before treatment. Let's create one using the `tableone` package.

```{r table_one, message = FALSE, warning = FALSE}
# Define variables for Table One
vars <- c(
  "age", "gender", "medication", "site", "coil_intensity",
  "MEP_amplitude",  "EEG_theta",  "EEG_alpha",  "EEG_beta","symptom_score"
  )
catVars <- c("gender", "site") # Categorical variables
strataVar <- "treatment" # Grouping variable

# Adjust variable type to properly represent it in the table
data$medication <- as.logical(data$medication)

# Create Table One with baseline data
data_baseline <- data %>% filter(time == "pre")
tableOne <- CreateTableOne(vars = vars, data = data_baseline, factorVars = catVars, strata = strataVar)
print(tableOne)
```

Now, it is your turn! Modify the variables in `vars` and `catVars` to include other baseline characteristics relevant to your study. Run the code to see how the groups compare before treatment.


# Regression model

## Simple linear regression

First, we'll fit a simple linear regression model to see how treatment affects symptom scores at follow-up, controlling for baseline scores.

```{r regression_model, message = FALSE, warning = FALSE}
data_followup <- data %>% filter(time == "followup")
model <- lm(symptom_score ~ treatment + symptom_baseline, data = data_followup)
summary(model)
```

This first model helps us understand whether treatment type (active vs. sham) has an effect on symptom scores at follow-up, while controlling for baseline severity.

**Key takeaways**

The treatmentsham estimate (~6.52, p < 0.001) suggests that participants in the sham group had, on average, higher symptom scores at follow-up compared to those in the active TMS group.

The baseline severity coefficient (~0.89, p < 0.001) shows a positive association: participants starting with more severe symptoms tended to also present higher symptom scores at follow-up.

The model explains a substantial portion of the variability in follow-up symptoms (R² = 0.82), suggesting that treatment type and baseline severity together are strong predictors of outcome.

**Clinically speaking**

This model indicates a clear benefit of active TMS compared to sham stimulation when adjusting for initial severity. While individual responses may vary, the overall trend strongly supports a meaningful treatment effect.

**Your turn**

Now, also add more predictors like age, gender and more to see if they influence outcomes.

# Mixed effects model

In this section, we'll fit a mixed effects model to account for repeated measures over time within subjects, which is common in clinical trials where we have multiple observations per patient (at pre, post, and follow-up).

```{r mixed_effects_model, message = FALSE, warning = FALSE}
model_mixed <- lmer(symptom_score ~ treatment * time + (1 | subject_id), data = data)
summary(model_mixed)
```

This second model accounts for repeated measures—each participant was assessed multiple times (pre, post, follow-up)—and thus includes a random intercept for each subject to capture individual differences.

**What the model includes**

*Fixed effects:* treatment, time, and their interaction (treatment × time).

*Random effects:* subject-level intercepts, allowing each participant to have their own baseline level of symptoms.

**Key results**

*Time effects:* Both timepost (-7.53) and timefollowup (-7.60) show large, negative coefficients (t = -15 and -14), meaning that symptom severity decreased significantly over time compared to the pre-treatment phase.

*Treatment main effect:* The treatmentsham term alone (-0.19) was small and not significant, indicating no overall difference between groups at baseline.

*Interaction effects:* Both treatmentsham:timepost (5.26) and treatmentsham:timefollowup (6.69) were large and significant, showing that sham participants improved less over time than those receiving active TMS.

**Random effects interpretation**

The subject-level variance (82.7) shows there are meaningful individual differences in baseline symptom levels.

The residual variance (9.8) reflects remaining within-person variability not explained by the model.

**Clinically speaking**

This mixed-effects approach confirms the pattern seen earlier: active TMS produced greater improvement over time. The strong time effects indicate that participants generally improved with treatment, but the interaction shows that the active group's improvement was larger and more sustained at follow-up. This supports the idea that active stimulation drives the observed changes.

# Additional resources:

If you'd like to keep exploring R on your own, here are some great resources to help you learn, practice, and grow your skills:

**1. Hands-On Programming with R:** A beginner-friendly introduction to R programming.  
Link: https://rstudio-education.github.io/hopr/

**2. RStudio Cheat Sheets:** Handy reference guides for data visualization, wrangling, and more.  
Link: https://posit.co/resources/cheatsheets/

**3. R for Data Science (by Hadley Wickham & Garrett Grolemund):** A free, in-depth book that covers tidy data workflows.  
Link: https://r4ds.hadley.nz/

**4. Documentation for the tableone package:** A practical guide to using the tableone package for creating descriptive summary tables commonly used in medical and epidemiological research.  
Link: https://cran.r-project.org/web/packages/tableone/vignettes/introduction.html

**5. YaRrr! The Pirate’s Guide to R:** Another introduction to R programming. It also includes a great beginner-friendly overview of linear models using the lm() function.   
Link: https://bookdown.org/ndphillips/YaRrr/

**6. An R companion to Statistics: data analysis and modelling:** A companion guide for learning statistical modeling in R, including detailed chapters on linear mixed-effects models using lmer().  
Link: https://mspeekenbrink.github.io/sdam-r-companion/index.html

**7. Fitting Linear Mixed-Effects Models Using lme4:** The official documentation for the lme4 package, explaining the theory, syntax, and practical examples for fitting mixed-effects models with lmer().  
Link: https://cran.r-project.org/web/packages/lme4/vignettes/lmer.pdf